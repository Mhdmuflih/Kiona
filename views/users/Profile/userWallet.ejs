<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wallet</title>

    <link rel="stylesheet" href="http://localhost:8000/css/userProfile.css">
    <link rel="icon" type="image/png" href="/kiona-logo.png" />
    <link rel="stylesheet" type="text/css" href="css/util.css">
    <link rel="stylesheet" type="text/css" href="css/main.css">
    <link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/bootstrap@4.5.0/dist/css/bootstrap.min.css'>
</head>

<body>
    <div class="top-bar">
        <div class="content-topbar flex-sb-m h-full container">
            <div class="left-top-bar">
                KIONA
            </div>
            <div class="right-top-bar flex-w h-full">
                <a href="#" class="flex-c-m trans-04 p-lr-25">
                    Help & FAQs
                </a>
                <% if(user){ %>
                    <a href="/" class="flex-c-m trans-04 p-lr-25">
                        Home
                    </a>
                    <a href="/userProfile" class="flex-c-m trans-04 p-lr-25">
                        My Account
                    </a>
                    <a href="/logout" class="flex-c-m trans-04 p-lr-25">
                        Logout
                    </a>
                    <% } else { %>
                        <a href="/login" class="flex-c-m trans-04 p-lr-25">
                            Login
                        </a>
                        <a href="/register" class="flex-c-m trans-04 p-lr-25">
                            Sign Up
                        </a>
                        <% } %>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="main-body">
            <div class="bg0 p-t-40 p-b-85">
                <div class="row">
                    <div class="col-lg-4">
                        <div class="card">
                            <div class="card-body">
                                <div class="d-flex flex-column align-items-center text-center">
                                    <img src="/Photos/userImages/<%= user.image %>" alt=""
                                        class="rounded-circle p-1 bg-primary" width="110">
                                    <div class="mt-3">
                                        <h4>
                                            <%= user.name %>
                                        </h4>
                                    </div>
                                </div>
                                <hr class="my-4">
                                <ul class="list-group list-group-flush">
                                    <li class="list-group-item d-flex justify-content-between align-items-center flex-wrap"
                                        style="width: 310px;">
                                        <a href="/userProfile"> <button type="button" class="btn btn-outline-dark"
                                                style="width: 280px;">User Profile</button> </a>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center flex-wrap"
                                        style="width: 310px;">
                                        <a href="/changePassword"> <button type="button" class="btn btn-outline-dark"
                                                style="width: 280px;">Change Password</button> </a>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center flex-wrap"
                                        style="width: 310px;">
                                        <a href="/address"> <button type="button" class="btn btn-outline-dark"
                                                style="width: 280px;">Address Management</button> </a>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center flex-wrap"
                                        style="width: 310px;">
                                        <a href="/order"> <button type="button" class="btn btn-outline-dark"
                                                style="width: 280px;">Order</button> </a>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center flex-wrap"
                                        style="width: 310px;">
                                        <a href="/wishlist"> <button type="button" class="btn btn-outline-dark"
                                                style="width: 280px;">Wishlist</button> </a>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center flex-wrap"
                                        style="width: 310px;">
                                        <a href="/wallet"> <button type="button" class="btn btn-dark"
                                                style="width: 280px;">Wallet</button> </a>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-8">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="d-flex align-items-center mb-3"> Balance & Rewards </h5>
                                <div style="padding-top: 15px; ;"></div>
                                <!-- <h1 class="mb-3"> USD</h1> -->

                                <!-- New Horizontal Boxes Section -->
                                <div class="row text-center">
                                    <div class="col-md-4">
                                        <div class="card" style="background-color: #2e2a21;">
                                            <div class="card-body">
                                                <p class="text-white font-weight-bold" style="font-size: 15px;"> Rs: <span> <%= walletData.balance %> </span> </p>
                                                <h5 class="text-white">Available Balance</h5>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card" style="background-color: #21cc99;">
                                            <div class="card-body">
                                                <p class="text-white font-weight-bold" style="font-size: 15px;"> Rs: 0 </p>
                                                <h5 class="text-white">Reward Balance</h5>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card" style="background-color: #d9234d;">
                                            <div class="card-body">
                                                <p class="text-white font-weight-bold" style="font-size: 15px;"> Rs: 0 </p>
                                                <h5 class="text-white">Pending Balance</h5>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- End of Horizontal Boxes Section -->

                                <hr class="my-4">
                                <h5 class="mb-3"> Payment History </h5>
                                <ul class="list-group">
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            <a href="/wallet/walletHistory" style="text-decoration: none; color: green;"> <span> View Payment History </span> </a>
                                            <span> </span>
                                        </li>
                                </ul>
                                <hr class="my-4">
                                <button type="button" onclick="showAddWalletModal()" style="background-color: #1ddb79; border: none; color: white; padding: 10px 20px; text-align: center; text-decoration: none; display: inline-block; font-size: 16px; margin: 4px 2px; cursor: pointer; border-radius: 5px;">Add Balance</button>
                                <button type="button" onclick="showWithrawWalletModal()" style="background-color: #ed4f2f; border: none; color: white; padding: 10px 20px; text-align: center; text-decoration: none; display: inline-block; font-size: 16px; margin: 4px 2px; cursor: pointer; border-radius: 5px;"> Withdraw Amount </button>
                                <!-- <button type="button" style="background-color: #ed4f2f; border: none; color: white; padding: 10px 20px; text-align: center; text-decoration: none; display: inline-block; font-size: 16px; margin: 4px 2px; cursor: pointer; border-radius: 5px;"> History </button> -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- modal -->

    <div class="modal fade" id="addWalletModal" tabindex="-1" aria-labelledby="addWalletModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addWalletModalLabel">Add Money to Wallet</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="addWalletForm">
                        <div class="form-group">
                            <label for="addAmount">Amount to Add:</label>
                            <input type="number" class="form-control" id="addAmount">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" data-dismiss="modal" style="background-color: #ed4f2f; border: none; color: white; padding: 7px 15px; text-align: center; text-decoration: none; display: inline-block; font-size: 16px; margin: 4px 2px; cursor: pointer; border-radius: 5px;"> Close </button>
                    <button type="button" onclick="submitAddWallet()" style="background-color: #2fed6e; border: none; color: white; padding: 7px 15px; text-align: center; text-decoration: none; display: inline-block; font-size: 16px; margin: 4px 2px; cursor: pointer; border-radius: 5px;"> Add to Wallet </button>
                </div>
            </div>
        </div>
    </div>

    <!-- modal in withdraw -->
    <div class="modal fade" id="withdrawWalletModal" tabindex="-1" aria-labelledby="addWalletModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addWalletModalLabel"> Withdraw Money </h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="addWalletForm">
                        <div class="form-group">
                            <label for="withdrawAmount">Amount to Withdraw:</label>
                            <input type="number" class="form-control" id="withdrawAmount">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" data-dismiss="modal" style="background-color: #ed4f2f; border: none; color: white; padding: 7px 15px; text-align: center; text-decoration: none; display: inline-block; font-size: 16px; margin: 4px 2px; cursor: pointer; border-radius: 5px;"> Close </button>
                    <button type="button" onclick="submitWithdrawWallet()" style="background-color: #2fed6e; border: none; color: white; padding: 7px 15px; text-align: center; text-decoration: none; display: inline-block; font-size: 16px; margin: 4px 2px; cursor: pointer; border-radius: 5px;"> Withdraw Wallet Money </button>
                </div>
            </div>
        </div>
    </div>



    <script src="http://localhost:8000/js/jquery.min.js"></script>
    <script src="http://localhost:8000/js/bootstrap.bundle.min.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/bootstrap@4.5.0/dist/js/bootstrap.bundle.min.js'></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>

    	<!-- razor pay cdn -->
	<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

    <script>

        function showAddWalletModal() {
            $('#addWalletModal').modal('show');
        }

        async function submitAddWallet() {
            const amount = $('#addAmount').val()
            const confirmation = await Swal.fire({
                title: 'Confirm Cancellation',
                text: "Are you sure you want to proceed with Cancel the Order?",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes, proceed!'
            });
            if(confirmation.isConfirmed){
                try {

                    const response = await axios.post('/addWalletAmount', { amount })
                    const{ key_id, walletAmount, walletId, razorpayWalletId } = response.data
                    console.log(response.data);

                    if(response.data.success){
						var options = {
							"key": key_id,
							"amount": walletAmount * 100,
							"currency": "INR",
							"name": "KIONA",
							"wallet_id":"",
							"description": "Wallet Amount",
							"image": "https://example.com/your_logo",

							"handler":function (response){
								console.log('Razorpay payment success', response);
								verifyPayment();
							},
							"prefill": {
								"name": "Customer Name",
								"email": "customer_email@example.com",
								"contact": "customer_phone"
							},
							"notes": {
								"address": "Razorpay Corporate Office"
							},
							"theme": {
								"color": "#192e68"
							}
						};
						var paymentGateway = new Razorpay(options);
						paymentGateway.open();
					}else{
						Swal.fire({
							icon: 'error',
							title: 'Failed!',
							text: response.data.message || 'Unable to process the order.'
						}).then(()=>{
							window.location.href = "/wallet"
						})
					}
				
                    
                } catch (error) {
                    console.log(error.message);
                    await Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'Something went wrong!'
                    });
                }
            }

        }


        async function verifyPayment() {
            try {
                const response = await axios.post('/verifyWalletAmount',);
                if (response.data.success) {
                    Swal.fire({
                        title: "Amount Added in Your Wallet",
                        text: "Your Wallet Amount is Confirmed",
                        icon: "success"
                    }).then(() => {
                        window.location.href = '/wallet';
                    });
                }
            } catch (error) {
                console.log(error.message);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Something went wrong!'
                });
            }
        }


        function showWithrawWalletModal(){
            $('#withdrawWalletModal').modal('show')
        }

        async function submitWithdrawWallet(){
            const amount = $('#withdrawAmount').val()
            console.log(amount);
            const confirmation = await Swal.fire({
                title: 'Confirm Cancellation',
                text: "Are you sure you want to proceed with Cancel the Order?",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes, proceed!'
            });
            if(confirmation.isConfirmed){
                try {
                    const response = await axios.post('/withdraw',{ amount })
                    if(response.data.success){
                            Swal.fire({
                            title: "Amount Withdraw in Your Wallet",
                            text: "Your Withdraw Wallet Amount is Confirmed",
                            icon: "success"
                        }).then(() => {
                            window.location.href = '/wallet';
                        });

                    }else{
                        Swal.fire({
                            icon:"error",
                            title:"error",
                            text:"error"
                        }).then(()=>{
                            window.location.reload();
                        })
                    }
                } catch (error) {
                    console.log(error.message);
                }
            }
        }

       
    </script>
</body>

</html>